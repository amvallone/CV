<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Curriculum Vitae — Andrés Marcelo Vallone</title>
  <style>
    :root{
      --bg:#f4f1e8;--primary:#3a3a2d;--accent:#bc7d38;--card:#ffffff;
      --sidebar:linear-gradient(180deg,#5a4a3a 0%,#6b5a47 100%);
      --green:#5e7050;--muted:#6d6d5d;--border:#d4cdb8;--sidebar-width:340px
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--primary);line-height:1.7;font-size:17px}
    /* SIDEBAR */
    .sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100vh;background:var(--sidebar);box-shadow:4px 0 20px rgba(0,0,0,.1);padding:24px 20px;display:flex;flex-direction:column;gap:16px;z-index:100;overflow-y:auto}
    .sidebar-photo{display:flex;justify-content:center;margin-bottom:8px}
    .sidebar-photo img{width:200px;height:200px;border-radius:16px;object-fit:cover;border:5px solid rgba(245,241,233,.8);box-shadow:0 8px 24px rgba(0,0,0,.2);background:#ddd}
    .sidebar-title{font-size:1.8rem;font-weight:700;color:#f5f1e9;text-align:center;line-height:1.2;margin-bottom:4px}
    .sidebar-subtitle{font-size:.96rem;color:#e8dcc8;text-align:center;line-height:1.3;padding:0 8px}
    .sidebar-contact{display:flex;flex-direction:column;gap:8px;font-size:.95rem;background:rgba(255,255,255,.08);border-radius:10px;padding:12px;margin-top:8px}
    .contact-icon{display:flex;align-items:center;gap:8px;text-decoration:none;color:#f7f4ef;transition:color .2s;word-break:break-word}
    .contact-icon:hover{color:var(--accent)}
    .contact-icon svg{width:18px;height:18px;flex-shrink:0;fill:currentColor}
    .lang-btn{margin-top:12px;padding:10px 20px;border:2px solid rgba(255,255,255,.3);background:var(--accent);color:#fff;cursor:pointer;border-radius:8px;font-size:.96rem;font-weight:600;align-self:center;transition:all .3s}
    .lang-btn:hover{background:#d08842;border-color:rgba(255,255,255,.5);transform:translateY(-2px)}
    .sidebar-divider{margin:12px 0;border-bottom:1px solid rgba(255,255,255,.25)}
    .sidebar-nav{margin-top:4px;display:flex;flex-direction:column;gap:6px}
    .sidebar-nav a{text-decoration:none;color:#f5f1e9;font-weight:600;font-size:.96rem;padding:10px 12px;border-radius:8px;background:rgba(245,241,233,.06);transition:all .2s}
    .sidebar-nav a:hover{background:rgba(245,241,233,.15);transform:translateX(4px)}

    /* MAIN */
    .main-content{margin-left:calc(var(--sidebar-width) + 24px);padding:32px 40px;max-width:1200px}
    .summary-box{background:var(--card);padding:20px 24px;border-radius:12px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,.05);border-left:4px solid var(--green)}
    .summary-box p{margin-bottom:12px;text-align:justify}
    .summary-box p:last-child{margin-bottom:0}
    .eyeem-link{display:inline-block;margin-left:8px;vertical-align:middle}
    .eyeem-link svg{width:20px;height:20px}
    .eyeem-link circle{fill:var(--accent)}
    .eyeem-link path{fill:#f4f1e8}
    section{margin-bottom:48px}
    h2{border-bottom:3px solid var(--green);padding-bottom:8px;margin-bottom:20px;color:var(--primary);font-size:1.9rem;font-weight:700}
    h3{color:var(--primary);font-size:1.3rem;margin-bottom:16px;font-weight:600}
    .subsection-title{margin-top:24px;margin-bottom:16px;color:var(--green);font-size:1.2rem;font-weight:600;padding-left:8px;border-left:4px solid var(--accent)}

    /* EDUCATION */
    .edu-item{display:flex;gap:16px;background:var(--card);margin-bottom:14px;padding:16px 18px;border-radius:10px;align-items:flex-start;box-shadow:0 2px 6px rgba(0,0,0,.04);border-left:4px solid var(--green);transition:transform .2s,box-shadow .2s}
    .edu-item:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .edu-icon{width:28px;height:28px;flex-shrink:0}
    .edu-icon svg{width:100%;height:100%}

    /* EXPERIENCE */
    .experience-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:24px}
    .exp-card{background:var(--card);padding:20px;border-radius:12px;border-top:4px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .exp-subtitle{color:var(--green);margin-top:16px;margin-bottom:12px;font-weight:700;font-size:1.1rem}
    .course-list,.pro-exp-list{list-style:none;padding-left:0}
    .course-list li,.pro-exp-list li{margin-bottom:10px;padding-left:20px;position:relative}
    .course-list li:before,.pro-exp-list li:before{content:"▸";position:absolute;left:0;color:var(--accent);font-weight:bold}

    /* PUBLICATIONS */
    .pub-item{background:var(--card);padding:16px 20px;border-radius:10px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.04);border-left:4px solid var(--accent)}
    .pub-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .pub-ref{text-align:justify}
    .pub-doi{color:var(--green);font-size:.9rem;margin-top:4px}
    .pub-doi a{color:var(--green);text-decoration:none}
    .pub-doi a:hover{text-decoration:underline}
    .abstract-toggle{margin-top:8px;padding:6px 10px;border-radius:6px;border:1px solid var(--green);background:transparent;cursor:pointer;font-size:.9rem;color:var(--green)}
    .abstract-toggle:hover{background:#e7efe6}
    .pub-abstract{display:none;margin-top:8px;padding:10px 12px;border-radius:8px;background:#f7f3ea;font-size:.95rem;color:var(--primary);text-align:justify}

    /* PRESENTATIONS */
    .talk-list{display:flex;flex-direction:column;gap:14px}
    .talk-item{display:grid;grid-template-columns:70px 1fr;gap:16px;background:var(--card);padding:16px 20px;border-radius:10px;border-left:4px solid var(--green);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:transform .2s,box-shadow .2s}
    .talk-item:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .year-badge{align-self:flex-start;background:linear-gradient(135deg,#e7efe6 0%,#d4e4d1 100%);color:var(--green);border:2px solid var(--green);border-radius:8px;padding:6px 10px;font-weight:700;font-size:1.1rem;text-align:center;min-width:60px}

    /* PROJECTS */
    .proj-list{display:flex;flex-direction:column;gap:16px}
    .proj-item{background:var(--card);padding:18px 22px;border-radius:10px;border-left:4px solid var(--accent);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:transform .2s,box-shadow .2s}
    .proj-item:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .proj-inner{display:grid;grid-template-columns:120px 1fr;gap:16px}
    .proj-title{font-weight:700;color:var(--primary);font-size:1.05rem}
    .proj-footer{margin-top:6px;color:var(--muted);font-size:.95rem}
    .proj-footer .sep{margin:0 6px;color:#a09b8c}

    /* AWARDS */
    .award-item{background:var(--card);padding:14px 18px;border-radius:8px;margin-bottom:12px;border-left:4px solid var(--accent);box-shadow:0 2px 6px rgba(0,0,0,.04);display:flex;gap:12px}
    .award-year{font-weight:700;color:var(--green);min-width:60px}

    /* RESPONSIVE */
    @media (max-width:1024px){
      .sidebar{position:static;width:100%;height:auto}
      .main-content{margin-left:0;padding:24px 20px}
      .sidebar-nav{flex-direction:row;flex-wrap:wrap}
      .experience-grid{grid-template-columns:1fr}
      .talk-item{grid-template-columns:60px 1fr}
      .proj-inner{grid-template-columns:90px 1fr}
    }
    @media (max-width:640px){
      .proj-inner{grid-template-columns:80px 1fr}
    }

    /* LOADING */
    .loading{text-align:center;padding:20px;color:var(--muted);font-style:italic}
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-photo">
      <img src="tu-foto.JPG" alt="Andrés Marcelo Vallone"/>
    </div>
    <div class="sidebar-title">Andrés Marcelo Vallone</div>
    <div class="sidebar-subtitle" id="affil-line"></div>

    <div class="sidebar-contact">
      <a class="contact-icon" href="mailto:avallone@ucn.cl">
        <svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
        avallone@ucn.cl
      </a>
      <a class="contact-icon" href="https://github.com/amvallone" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24"><path d="M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.02c-3.34.73-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.1-.75.08-.74.08-.74 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.84 1.32 3.53 1.01.11-.79.42-1.32.76-1.63-2.67-.31-5.47-1.34-5.47-5.98 0-1.32.47-2.39 1.24-3.23-.12-.31-.54-1.56.12-3.25 0 0 1.01-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.29-1.55 3.3-1.23 3.3-1.23.66 1.69.24 2.94.12 3.25.77.84 1.24 1.91 1.24 3.23 0 4.65-2.8 5.66-5.48 5.97.43.37.81 1.1.81 2.22v3.29c0 .32.21.7.82.58A12 12 0 0 0 12 .5z"/></svg>
        GitHub
      </a>
      <a class="contact-icon" href="https://www.researchgate.net/profile/Andres-Vallone" target="_blank" rel="noopener">
        <svg viewBox="0 0 80 80"><circle cx="40" cy="40" r="36"/><text x="22" y="48" font-size="25" fill="#fff" font-family="Arial, sans-serif">RG</text></svg>
        ResearchGate
      </a>
      <a class="contact-icon" href="https://orcid.org/0000-0002-9258-2209" target="_blank" rel="noopener">
        <svg viewBox="0 0 256 256"><circle cx="128" cy="128" r="120" fill="#A6CE39"/><path fill="#fff" d="M111 92h14v72h-14V92zm7-30c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9zm26 30h14v40c0 6 1 10 3 13 2 2 5 4 9 4 4 0 7-1 9-4 2-3 3-7 3-13V92h14v40c0 10-2 17-6 22-4 5-10 8-18 8-9 0-15-3-19-9-3-5-5-12-5-21V92z"/></svg>
        ORCID: 0000-0002-9258-2209
      </a>
      <a class="contact-icon" href="https://www.scopus.com/authid/detail.uri?authorId=56266470300" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="7" y="16" font-size="9" fill="#f4f1e8" font-family="Arial, sans-serif">Sc</text></svg>
        Scopus ID: 56266470300
      </a>
      <a class="contact-icon" href="https://www.webofscience.com/wos/author/record/AEI-2718-2022" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><text x="5.5" y="16" font-size="9" fill="#f4f1e8" font-family="Arial, sans-serif">WoS</text></svg>
        ResearcherID: AEI-2718-2022
      </a>
    </div>

    <button class="lang-btn" id="lang-btn">English / Español</button>
    <div class="sidebar-divider"></div>

    <nav class="sidebar-nav">
      <a href="#general" id="nav-general"></a>
      <a href="#education" id="nav-education"></a>
      <a href="#experience" id="nav-experience"></a>
      <a href="#publications" id="nav-publications"></a>
      <a href="#projects" id="nav-projects"></a>
      <a href="#conferences" id="nav-conferences"></a>
      <a href="#awards" id="nav-awards"></a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <section id="general">
      <h2 id="general-title"></h2>
      <div class="summary-box" id="general-box"></div>
    </section>

    <section id="education">
      <h2 id="education-title"></h2>
      <div id="education-list"></div>
    </section>

    <section id="experience">
      <h2 id="experience-title"></h2>
      <div class="experience-grid">
        <div class="exp-card">
          <h3 id="pro-exp-title"></h3>
          <ul id="pro-exp-list" class="pro-exp-list"></ul>
        </div>
        <div class="exp-card">
          <h3 id="teaching-exp-title"></h3>
          <div class="exp-subtitle" id="undergrad-title"></div>
          <ul id="undergrad-list" class="course-list"></ul>
          <div class="exp-subtitle" id="postgrad-title"></div>
          <ul id="postgrad-list" class="course-list"></ul>
        </div>
      </div>
    </section>

    <section id="publications">
      <h2 id="publications-title"></h2>
      <div class="loading">Cargando publicaciones...</div>
      <h3 class="subsection-title" id="pub-journals-title"></h3>
      <div id="publications-journals-list"></div>
      <h3 class="subsection-title" id="pub-chapters-title"></h3>
      <div id="publications-chapters-list"></div>
    </section>

    <section id="projects">
      <h2 id="projects-title"></h2>
      <div class="loading">Cargando proyectos...</div>
      <div id="projects-list" class="proj-list"></div>
    </section>

    <section id="conferences">
      <h2 id="conferences-title"></h2>
      <div class="loading">Cargando presentaciones...</div>
      <div id="conferences-list" class="talk-list"></div>
    </section>

    <section id="awards">
      <h2 id="awards-title"></h2>
      <div id="awards-list"></div>
    </section>
  </main>

  <script>
    /* ====== TEXT CONTENT ====== */
    const CONTENT={
      es:{
        affil:"Universidad Católica del Norte — Escuela de Ciencias Empresariales — Instituto de Políticas Públicas",
        nav:["Acerca de mí","Educación","Experiencia","Publicaciones","Proyectos","Presentaciones","Becas y Premios"],
        generalTitle:"Acerca de mí",
        generalHTML:`
          <p>Economista argentino nacido en San Juan. Actualmente Profesor Asociado en la Escuela de Ciencias Empresariales de la Universidad Católica del Norte, Chile. Mi formación académica se desarrolló en Argentina, Chile y España.</p>
          <p>Mi investigación se centra en fenómenos sociales espaciales, con énfasis en procesos espacio-temporales. Mis áreas de interés incluyen econometría espacial, desarrollo regional, análisis de redes de colaboración científica y procesos de innovación a través del estudio de patentes. Trabajo con programación en R para análisis de datos y modelización espacial.</p>
          <p>He publicado en revistas internacionales sobre temas como dinámicas urbanas, sostenibilidad, redes de co-invención de patentes, uso de pesticidas y competitividad exportadora. Participo en proyectos de investigación sobre desarrollo territorial, economía pesquera, huella de carbono y gestión de residuos en salud.</p>
          <p>Fuera del ámbito académico, practico fotografía y toco guitarra. Mi gusto musical incluye a Pearl Jam, Tool, Jimi Hendrix, B.B. King, Gary Clark Jr., Incubus, Mozart y Paco de Lucía.
            <a href="https://www.eyeem.com/u/25320134" target="_blank" rel="noopener" class="eyeem-link" aria-label="EyeEm">
              <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M8 12a4 4 0 1 0 8 0 4 4 0 0 0-8 0z"></path></svg>
            </a>
          </p>
        `,
        educationTitle:"Educación",experienceTitle:"Experiencia",publicationsTitle:"Publicaciones",
        projectsTitle:"Proyectos de investigación",conferencesTitle:"Presentaciones en Congresos",
        awardsTitle:"Becas y Premios",publicationsJournalsTitle:"Revistas indexadas",
        publicationsChaptersTitle:"Capítulos de libro",proExpTitle:"Experiencia profesional",
        teachingExpTitle:"Experiencia docente",undergradTitle:"Pregrado",postgradTitle:"Postgrado",
        abstractLabels:{show:"Ver resumen",hide:"Ocultar resumen"}
      },
      en:{
        affil:"Universidad Católica del Norte — School of Business Sciences — Institute of Public Policy",
        nav:["About me","Education","Experience","Publications","Projects","Presentations","Scholarships & Awards"],
        generalTitle:"About me",
        generalHTML:`
          <p>Argentinian economist born in San Juan. Currently Associate Professor at the School of Business Sciences, Universidad Católica del Norte (Chile). My academic training took place in Argentina, Chile, and Spain.</p>
          <p>My research focuses on spatial social phenomena with an emphasis on space–time processes. Interests include spatial econometrics, regional development, collaboration networks in science, and innovation through patent analysis. I work with R for data analysis and spatial modeling.</p>
          <p>I have published on urban dynamics, sustainability, patent co-invention networks, pesticide use, and export competitiveness. I participate in research on territorial development, fisheries economics, carbon footprint, and healthcare waste management.</p>
          <p>Beyond academia, I practice photography and play guitar. I enjoy Pearl Jam, Tool, Jimi Hendrix, B.B. King, Gary Clark Jr., Incubus, Mozart, and Paco de Lucía.
            <a href="https://www.eyeem.com/u/25320134" target="_blank" rel="noopener" class="eyeem-link" aria-label="EyeEm">
              <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M8 12a4 4 0 1 0 8 0 4 4 0 0 0-8 0z"></path></svg>
            </a>
          </p>
        `,
        educationTitle:"Education",experienceTitle:"Experience",publicationsTitle:"Publications",
        projectsTitle:"Research Projects",conferencesTitle:"Conference Presentations",
        awardsTitle:"Scholarships & Awards",publicationsJournalsTitle:"Indexed journals",
        publicationsChaptersTitle:"Book chapters",proExpTitle:"Professional experience",
        teachingExpTitle:"Teaching experience",undergradTitle:"Undergraduate",postgradTitle:"Postgraduate",
        abstractLabels:{show:"Show abstract",hide:"Hide abstract"}
      }
    };

    let currentLang='es';
    let publicationsCache=[],presentationsCache=[],projectsCache=[];

    /* ====== UTILS ====== */
    function stripComments(t){return t.replace(/\r\n?/g,'\n').replace(/(^|[^\\])%.*$/gm,'$1')}
    function readBraced(text,startIdx){
      let i=startIdx;if(text[i]!=='{')return null;let depth=0,value='';
      for(;i<text.length;i++){const ch=text[i];if(ch==='{'){depth++;if(depth>1)value+=ch}
        else if(ch==='}'){depth--;if(depth===0)return{value,end:i};value+=ch}else{value+=ch}}
      return null
    }
    function parseLatexCommand(text,cmdName,minArgs,maxArgs){
      const out=[];const re=new RegExp('\\\\'+cmdName+'\\*?(?:\\[[^\\]]*\\])?\\s*\\{','g');let m;
      while((m=re.exec(text))!==null){let idx=m.index+m[0].length-1;const args=[];
        for(let k=0;k<maxArgs;k++){while(idx<text.length&&/\\s/.test(text[idx]))idx++;if(text[idx]!=='{')break;
          const block=readBraced(text,idx);if(!block)break;args.push(block.value.trim());idx=block.end+1}
        if(args.length>=minArgs)out.push(args)}
      return out
    }
    function cleanLatex(s){if(!s)return'';let t=s;
      const bold=/\\textbf\\s*\\{/g;let m;while((m=bold.exec(t))!==null){const start=m.index+m[0].length-1;const b=readBraced(t,start);if(!b)break;t=t.slice(0,m.index)+'<strong>'+b.value+'</strong>'+t.slice(b.end+1)}
      t=t.replace(/\\textit\\{([^}]+)\\}/g,'<em>$1</em>').replace(/\\_/g,'_').replace(/\\\\/g,'<br>');
      return t
    }
    function extractYear(str){const mm=String(str||'').match(/\b(19|20)\d{2}\b/);return mm?parseInt(mm[0]):-1}

    /* ====== BIBTEX ====== */
    function parseBibtex(text){
      const entries=[];const chunks=text.split(/@(?=[a-zA-Z]+)/).filter(Boolean);
      chunks.forEach(ch=>{
        const typeMatch=ch.match(/^([a-zA-Z]+)\s*{/); if(!typeMatch) return;
        const type=typeMatch[1].toLowerCase();
        const keyMatch=ch.match(/^[a-zA-Z]+\s*{\s*([^,]+),/); const key=keyMatch?keyMatch[1].trim():'';
        const body=ch.substring(ch.indexOf('{')+1,ch.lastIndexOf('}')); const fields={};
        const fieldRegex=/(\w+)\s*=\s*(\{(?:[^{}]|{[^{}]*})*\}|\"[^\"]*\")\s*,?/g; let m;
        while((m=fieldRegex.exec(body))!==null){const name=m[1].toLowerCase();let value=m[2].trim();
          if((value.startsWith('{')&&value.endsWith('}'))||(value.startsWith('"')&&value.endsWith('"'))){value=value.slice(1,-1)}
          fields[name]=value.replace(/\s+/g,' ').trim()}
        entries.push({type,key,...fields})
      });return entries
    }
    function formatAuthorsAPA(str){
      if(!str) return '';
      const parts=str.split(/\s+and\s+/i).map(s=>s.trim()).filter(Boolean);
      const formatted=parts.map(a=>{
        if(a.includes(',')){const [last,first]=a.split(',').map(x=>x.trim());
          const initials=(first||'').split(/\s+/).map(n=>n[0]?n[0].toUpperCase()+'.':'').join(' ');
          return `${last}, ${initials}`.trim()
        }else{const toks=a.split(/\s+/);const last=toks.pop();
          const initials=toks.map(n=>n[0]?n[0].toUpperCase()+'.':'').join(' ');
          return `${last}, ${initials}`.trim()}
      });
      if(formatted.length===1) return formatted[0];
      if(formatted.length===2) return formatted.join(' & ');
      return formatted.slice(0,-1).join(', ')+', & '+formatted[formatted.length-1]
    }
    function formatApaReference(pub,lang){
      const authors=formatAuthorsAPA(pub.author);
      const year=pub.year?` (${pub.year}).`:`.`;
      const title=pub.title?` ${pub.title.replace(/\s+/g,' ').trim().replace(/\.$/,'')}.`:'';
      const doiCore=pub.doi?pub.doi.replace(/^https?:\/\/(dx\.)?doi\.org\//,''):'';
      let ref=''; if(authors) ref+=authors; ref+=year; ref+=title;

      if(pub.type==='incollection'||pub.booktitle){
        ref+=(lang==='es'?' En ':' In ');
        if(pub.booktitle){ref+=`<em>${pub.booktitle.replace(/\.$/,'')}</em>`}
        if(pub.pages){ref+=` (pp. ${pub.pages}).`} else if(pub.booktitle){ref+='.'}
        if(pub.publisher){ref+=` ${pub.publisher}.`}
      }else{
        if(pub.journal){
          ref+=` <em>${pub.journal}</em>`;
          if(pub.volume){ref+=`, <em>${pub.volume}</em>${pub.number?`(${pub.number})`:''}`}
          else if(pub.number){ref+=`, (${pub.number})`}
          if(pub.pages){ref+=`, ${pub.pages}`}
          ref+='.'
        }else if(pub.pages){ref+=` ${pub.pages}.`}
      }
      if(doiCore){ref+=` <span class="pub-doi"><a href="https://doi.org/${doiCore}" target="_blank" rel="noopener">https://doi.org/${doiCore}</a></span>`}
      return ref
    }

    /* ====== PRESENTATIONS & PROJECTS PARSERS ====== */
    function parsePresentations(text){
      text=stripComments(text).replace(/\\cvsection\*?\{[^}]*\}.*$/gm,'');
      const out=[];
      // Try cventry{event}{title}{place}{year}{extra}{...}
      let entries=parseLatexCommand(text,'cventry',4,6);
      if(entries.length){
        entries.forEach(args=>{
          let yearIndex=-1;
          for(let i=0;i<args.length;i++){ if(/\b(19|20)\d{2}\b/.test(args[i])){yearIndex=i;break} }
          const year=yearIndex>=0?args[yearIndex]:(args[0]||'');
          const parts=args.filter((_,idx)=>idx!==yearIndex);
          out.push({year,parts});
        });
      }else{
        // Fallback: cvpub{year}{title}{event}{place}{extra}
        entries=parseLatexCommand(text,'cvpub',2,6);
        entries.forEach(args=>{ const year=args[0]||''; const parts=args.slice(1); out.push({year,parts});});
      }
      return out
    }

    // NEW: parse \cventru{FUNDING}{TITLE}{ROLE}{PERIOD}{AMOUNT}
    function parseProjects(text){
      text=stripComments(text).replace(/\\cvsection\*?\{[^}]*\}.*$/gm,'');
      let results=[];
      // Prefer the user's structure
      let entries=parseLatexCommand(text,'cventru',5,5);
      if(entries.length){
        results=entries.map(a=>({
          funding:a[0]||'',
          title:a[1]||'',
          role:a[2]||'',
          period:a[3]||'',
          amount:a[4]||''
        }));
      }else{
        // Fallbacks for older files
        // cvpub{funding}{title}{role}{period}{amount}
        entries=parseLatexCommand(text,'cvpub',5,5);
        if(entries.length){
          results=entries.map(a=>({funding:a[0]||'',title:a[1]||'',role:a[2]||'',period:a[3]||'',amount:a[4]||''}));
        }else{
          // cventry with best-effort mapping
          entries=parseLatexCommand(text,'cventry',4,6);
          results=entries.map(a=>{
            // Try to infer period (arg containing a year)
            let pIdx=-1; for(let i=0;i<a.length;i++){ if(/\b(19|20)\d{2}/.test(a[i])){pIdx=i;break} }
            const period=pIdx>=0?a[pIdx]:(a[3]||a[0]||'');
            return {
              funding:a[0]||'',
              title:a[1]||a[0]||'',
              role:a[2]||'',
              period,
              amount:a[4]||''
            }
          });
        }
      }
      return results
    }

    /* ====== RENDER ====== */
    function renderGeneral(lang){
      const c=CONTENT[lang];
      document.getElementById('general-title').textContent=c.generalTitle;
      document.getElementById('general-box').innerHTML=c.generalHTML;
      document.getElementById('affil-line').textContent=c.affil;
    }
    function renderEducation(lang){
      const box=document.getElementById('education-list'); box.innerHTML='';
      const list=(lang==='es'?CONTENT.es:CONTENT.en).education;
      list.forEach(edu=>{
        const el=document.createElement('div'); el.className='edu-item';
        el.innerHTML=`<div class="edu-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="#5e7050">
              <path d="M32 6 2 20l30 14 30-14L32 6zm0 30.6L10 26v12l22 10 22-10V26L32 36.6z"/>
            </svg>
          </div>
          <div><strong>${edu.degree}</strong> – ${edu.institution}<br><small style="color:var(--muted)">${edu.years}</small></div>`;
        box.appendChild(el);
      });
    }
    function renderExperience(lang){
      const c=CONTENT[lang];
      document.getElementById('pro-exp-title').textContent=c.proExpTitle;
      document.getElementById('teaching-exp-title').textContent=c.teachingExpTitle;
      document.getElementById('undergrad-title').textContent=c.undergradTitle;
      document.getElementById('postgrad-title').textContent=c.postgradTitle;

      const pro=document.getElementById('pro-exp-list'); pro.innerHTML='';
      CONTENT[lang].proExperience.forEach(e=>{const li=document.createElement('li');li.innerHTML=`<strong>${e.period}</strong> — ${e.text}`;pro.appendChild(li)});
      const ug=document.getElementById('undergrad-list'); ug.innerHTML='';
      CONTENT[lang].undergradCourses.forEach(t=>{const li=document.createElement('li');li.textContent=t;ug.appendChild(li)});
      const pg=document.getElementById('postgrad-list'); pg.innerHTML='';
      CONTENT[lang].postgradCourses.forEach(t=>{const li=document.createElement('li');li.textContent=t;pg.appendChild(li)});
    }
    function renderPublications(lang){
      const jl=document.getElementById('publications-journals-list');
      const cl=document.getElementById('publications-chapters-list');
      jl.innerHTML=''; cl.innerHTML='';
      if(!publicationsCache.length) return;
      const sorted=[...publicationsCache].sort((a,b)=>(b.year||'').localeCompare(a.year||''));
      sorted.forEach(pub=>{
        const isChapter=pub.type==='incollection'||!!pub.booktitle;
        const item=document.createElement('div'); item.className='pub-item';
        const refHTML=formatApaReference(pub,lang);
        const hasAbstract=!!pub.abstract;
        const abstractHTML=hasAbstract?`
          <button type="button" class="abstract-toggle">${CONTENT[lang].abstractLabels.show}</button>
          <div class="pub-abstract">${cleanLatex(pub.abstract)}</div>`:'';
        item.innerHTML=`<div class="pub-ref">${refHTML}</div>${abstractHTML}`;
        (isChapter?cl:jl).appendChild(item);
      });
    }
    function renderConferences(){
      const list=document.getElementById('conferences-list'); list.innerHTML='';
      if(!presentationsCache.length) return;
      const sorted=[...presentationsCache].sort((a,b)=>extractYear(b.year)-extractYear(a.year));
      sorted.forEach(conf=>{
        const year=String(conf.year||'').replace(/<[^>]+>/g,'');
        const rest=conf.parts?conf.parts.join(' — '):'';
        const item=document.createElement('div'); item.className='talk-item';
        item.innerHTML=`<div class="year-badge">${year}</div>
                        <div class="talk-content"><strong>${cleanLatex(rest)}</strong></div>`;
        list.appendChild(item);
      });
    }
    // ORDER: period → title → funding → role
    function renderProjects(){
      const list=document.getElementById('projects-list'); list.innerHTML='';
      if(!projectsCache.length) return;
      const sorted=[...projectsCache].sort((a,b)=>extractYear(b.period)-extractYear(a.period));
      sorted.forEach(p=>{
        const item=document.createElement('div'); item.className='proj-item';
        item.innerHTML=`
          <div class="proj-inner">
            <div class="year-badge">${p.period||''}</div>
            <div>
              <div class="proj-title">${cleanLatex(p.title||'')}</div>
              <div class="proj-footer">
                <span class="proj-funding">${cleanLatex(p.funding||'')}</span>
                <span class="sep">·</span>
                <span class="proj-role">${cleanLatex(p.role||'')}</span>
              </div>
            </div>
          </div>`;
        list.appendChild(item);
      });
    }
    function renderAwards(lang){
      const list=document.getElementById('awards-list'); list.innerHTML='';
      const sorted=[...CONTENT[lang].awards].sort((a,b)=>extractYear(b.year)-extractYear(a.year));
      sorted.forEach(a=>{const el=document.createElement('div');el.className='award-item';el.innerHTML=`<div class="award-year">${a.year}</div><div>${a.text}</div>`;list.appendChild(el)});
    }
    function updateNavigation(lang){
      const n=CONTENT[lang].nav;
      document.getElementById('nav-general').textContent=n[0];
      document.getElementById('nav-education').textContent=n[1];
      document.getElementById('nav-experience').textContent=n[2];
      document.getElementById('nav-publications').textContent=n[3];
      document.getElementById('nav-projects').textContent=n[4];
      document.getElementById('nav-conferences').textContent=n[5];
      document.getElementById('nav-awards').textContent=n[6];
      document.getElementById('education-title').textContent=CONTENT[lang].educationTitle;
      document.getElementById('experience-title').textContent=CONTENT[lang].experienceTitle;
      document.getElementById('publications-title').textContent=CONTENT[lang].publicationsTitle;
      document.getElementById('projects-title').textContent=CONTENT[lang].projectsTitle;
      document.getElementById('conferences-title').textContent=CONTENT[lang].conferencesTitle;
      document.getElementById('awards-title').textContent=CONTENT[lang].awardsTitle;
      document.getElementById('pub-journals-title').textContent=CONTENT[lang].publicationsJournalsTitle;
      document.getElementById('pub-chapters-title').textContent=CONTENT[lang].publicationsChaptersTitle;
    }
    function renderAll(lang){
      updateNavigation(lang);
      renderGeneral(lang);
      renderEducation(lang);
      renderExperience(lang);
      renderAwards(lang);
      renderPublications(lang);
      renderConferences();
      renderProjects();
    }
    function toggleLanguage(){currentLang=currentLang==='es'?'en':'es';renderAll(currentLang)}

    /* ====== LOADERS ====== */
    async function loadBibtex(){
      const loading=document.querySelector('#publications .loading');
      try{
        const resp=await fetch('./library.bib?t='+Date.now());
        if(!resp.ok){if(loading)loading.textContent='No se pudo cargar library.bib';return}
        const text=await resp.text(); publicationsCache=parseBibtex(text);
        renderPublications(currentLang); if(loading)loading.style.display='none';
      }catch{if(loading)loading.textContent='Error al cargar publicaciones'}
    }
    async function loadPresentations(){
      const loading=document.querySelector('#conferences .loading');
      async function tryLoad(name){try{const r=await fetch('./'+name+'?t='+Date.now()); if(!r.ok) return null; return await r.text()}catch{return null}}
      let text=await tryLoad('presentations.tex'); if(!text) text=await tryLoad('presentation.tex');
      if(!text){if(loading)loading.textContent='No se pudo cargar presentations.tex/presentation.tex';return}
      presentationsCache=parsePresentations(text); renderConferences(); if(loading)loading.style.display='none';
    }
    async function loadProjects(){
      const loading=document.querySelector('#projects .loading');
      try{
        const resp=await fetch('./project.tex?t='+Date.now());
        if(!resp.ok){if(loading)loading.textContent='No se pudo cargar project.tex';return}
        const text=await resp.text(); projectsCache=parseProjects(text);
        renderProjects(); if(loading)loading.style.display='none';
      }catch{if(loading)loading.textContent='Error al cargar proyectos'}
    }

    /* ====== INIT ====== */
    document.addEventListener('DOMContentLoaded',()=>{
      currentLang='es'; renderAll('es');
      loadBibtex(); loadPresentations(); loadProjects();
      const btn=document.getElementById('lang-btn'); if(btn) btn.addEventListener('click',toggleLanguage);
      // Delegación: ver/ocultar abstract
      document.addEventListener('click',e=>{
        if(e.target.classList.contains('abstract-toggle')){
          const btn=e.target, abs=btn.nextElementSibling;
          if(!abs) return;
          const hidden=abs.style.display===''||abs.style.display==='none';
          abs.style.display=hidden?'block':'none';
          btn.textContent=hidden?CONTENT[currentLang].abstractLabels.hide:CONTENT[currentLang].abstractLabels.show;
        }
      });
    });
  </script>
</body>
</html>
