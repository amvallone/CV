<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Curriullum Vitae Andres Marcelo Vallone</title>
  <style>
    :root {
      --bg: #dfddcf;
      --primary: #3a3a2d;
      --accent: #bc7d38;
      --card: #f5f1e9;
      --sidebar: #5a4a3a;
      --sidebar-w: 310px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #2c2c2c;
      line-height: 1.5;
      font-size: 15px;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-w);
      height: 100vh;
      background: linear-gradient(180deg, #5a4a3a 0%, #6b5a47 100%);
      box-shadow: 2px 0 12px rgba(0,0,0,0.08);
      padding: 18px 16px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 50;
    }
    .sidebar-photo { display: flex; justify-content: center; margin-bottom: 4px; }
    .sidebar-photo img {
      width: 160px; height: 160px; border-radius: 14px; object-fit: cover;
      border: 4px solid rgba(242, 231, 209, 0.7);
      box-shadow: 0 6px 18px rgba(0,0,0,0.15); background: #ddd;
    }
    .sidebar-title { font-size: 1.1rem; font-weight: bold; color: #f5f1e9; text-align: center; line-height: 1.2; }
    .sidebar-contact {
      display: flex; flex-direction: column; gap: 6px;
      font-size: 0.8rem;
      align-items: flex-start; background: rgba(243, 237, 225, 0.08);
      border-radius: 8px; padding: 6px 4px;
    }
    .contact-icon { display: inline-flex; align-items: center; gap: 6px; text-decoration: none; color: #f7f4ef; font-size: 0.78rem; }
    .contact-icon svg { width: 15px; height: 15px; flex: 0 0 15px; fill: #f7f4ef; }
    .lang-btn {
      margin-top: 4px; padding: 6px 14px; border: none; background: var(--accent); color: white;
      cursor: pointer; border-radius: 5px; font-size: 0.75rem; align-self: center;
    }
    nav.sidebar-nav { margin-top: 6px; display: flex; flex-direction: column; gap: 5px; }
    nav.sidebar-nav a {
      text-decoration: none; color: #f5f1e9; font-weight: 600; font-size: 0.8rem;
      padding: 6px 10px; border-radius: 6px; background: rgba(245,241,233,0.05);
    }
    nav.sidebar-nav a:hover { background: rgba(245,241,233,0.18); }
    .main-content { margin-left: calc(var(--sidebar-w) + 16px); padding: 20px; max-width: 1000px; }
    .summary-box { background: var(--card); padding: 10px 12px; border-radius: 8px; margin-bottom: 18px; font-size: 0.98rem; }
    section { margin-bottom: 28px; }
    h2 { border-bottom: 2px solid rgba(90, 74, 58, 0.55); padding-bottom: 5px; margin-bottom: 15px; color: var(--primary); }
    ul { padding-left: 0; list-style: none; }
    .subsection-title { margin-top: 12px; margin-bottom: 10px; font-size: 0.9rem; color: #3a3a2d; }
    .edu-item, .card-list-item {
      display: flex; gap: 10px; background: #f1ede5; margin-bottom: 10px; padding: 10px 12px;
      border-radius: 8px; align-items: flex-start; font-size: 0.9rem;
    }
    .edu-icon, .card-icon { width: 22px; height: 22px; flex: 0 0 22px; }
    .experience-grid { display: flex; gap: 15px; flex-wrap: wrap; }
    .exp-card {
      background: #f1ede5; flex: 1 1 380px; padding: 12px; border-radius: 10px;
      border-top: 3px solid rgba(146, 133, 110, 0.55); font-size: 0.9rem;
    }
    .exp-subtitle { font-size: 0.8rem; color: #5d523f; margin-top: 8px; margin-bottom: 4px; font-weight: bold; }
    .pub-abstract {
      background: rgba(0,0,0,0.03);
      margin-top: 6px;
      padding: 6px 8px;
      border-left: 3px solid #bc7d38;
      border-radius: 4px;
      font-size: 0.78rem;
      color: #3b372f;
    }
    .skills-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .skill-card { background: #f1ede5; border-radius: 8px; padding: 12px; font-size: 0.9rem; }
    .award-item { background: #f1ede5; padding: 10px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #bc7d38; }
    @media (max-width: 900px) {
      .sidebar { position: static; width: 100%; height: auto; flex-direction: row; flex-wrap: wrap; }
      .main-content { margin-left: 0; }
      nav.sidebar-nav { flex-direction: row; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-photo"><img src="tu-foto.JPG" alt="Foto personal" /></div>
    <div class="sidebar-title" id="title">Curriullum Vitae Andres Marcelo Vallone</div>
    <div class="sidebar-contact">
      <a class="contact-icon" href="mailto:avallone@ucn.cl">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
        avallone@ucn.cl
      </a>
      <a class="contact-icon" href="https://www.researchgate.net/profile/Andres-Vallone?ev=hdr_xprf" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="36" fill="#4aa471" />
          <text x="22" y="48" font-size="25" fill="#fff" font-family="Arial, sans-serif">RG</text>
        </svg>
        ResearchGate
      </a>
      <a class="contact-icon" href="https://orcid.org/0000-0002-9258-2209" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" width="14" height="14">
          <circle cx="128" cy="128" r="120" fill="#A6CE39"/>
          <path fill="#fff" d="M111 92h14v72h-14V92zm7-30c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9zm26 30h14v40c0 6 1 10 3 13 2 2 5 4 9 4 4 0 7-1 9-4 2-3 3-7 3-13V92h14v40c0 10-2 17-6 22-4 5-10 8-18 8-9 0-15-3-19-9-3-5-5-12-5-21V92z"/>
        </svg>
        ORCID: 0000-0002-9258-2209
      </a>
      <span class="contact-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4h16v2H4V4zm2 4h12v2H6V8zm-2 4h16v2H4v-2zm2 4h12v2H6v-2z"/></svg>
        Web of Science ID: AEI-2718-2022
      </span>
      <span class="contact-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h18v2H3V5zm0 4h14v2H3V9zm0 4h10v2H3v-2zm0 4h6v2H3v-2z"/></svg>
        Scopus ID: 56266470300
      </span>
    </div>
    <button class="lang-btn" onclick="toggleLanguage()">English / Español</button>
    <nav class="sidebar-nav">
      <a href="#general" id="nav-general">Información General</a>
      <a href="#education" id="nav-education">Educación</a>
      <a href="#experience" id="nav-experience">Experiencia</a>
      <a href="#publications" id="nav-publications">Publicaciones</a>
      <a href="#projects" id="nav-projects">Proyectos</a>
      <a href="#conferences" id="nav-conferences">Presentaciones</a>
      <a href="#skills" id="nav-skills">Capacidades</a>
      <a href="#awards" id="nav-awards">Becas y Premios</a>
    </nav>
  </aside>

  <main class="main-content">
    <section id="general">
      <h2 id="general-title">Información General</h2>
      <div class="summary-box" id="summary-text">
        Profesor Asociado en la Universidad Católica del Norte (Escuela de Ciencias Empresariales / Instituto de Políticas Públicas, Coquimbo, Chile). Especializado en economía regional y urbana, redes de innovación y análisis espacial.
      </div>
      <p id="general-text">
        Afiliación actual: Universidad Católica del Norte, Escuela de Ciencias Empresariales - Instituto de Políticas Públicas, Coquimbo, Chile.
      </p>
    </section>

    <section id="education">
      <h2 id="education-title">Educación</h2>
      <ul id="education-list"></ul>
    </section>

    <section id="experience">
      <h2 id="experience-title">Experiencia</h2>
      <div class="experience-grid">
        <div class="exp-card">
          <h3 id="teaching-exp-title">Experiencia docente</h3>
          <div class="exp-subtitle" id="undergrad-title">Pregrado</div>
          <ul id="undergrad-list" class="course-list"></ul>
          <div class="exp-subtitle" id="postgrad-title">Postgrado</div>
          <ul id="postgrad-list" class="course-list"></ul>
        </div>
        <div class="exp-card">
          <h3 id="other-exp-title">Otras experiencias</h3>
          <ul id="other-exp-list" class="other-exp-list"></ul>
        </div>
      </div>
    </section>

    <section id="publications">
      <h2 id="publications-title">Publicaciones</h2>
      <h3 class="subsection-title" id="pub-journals-title">Revistas indexadas</h3>
      <ul id="publications-journals-list"></ul>
      <h3 class="subsection-title" id="pub-chapters-title">Capítulos de libro</h3>
      <ul id="publications-chapters-list"></ul>
    </section>

    <section id="projects">
      <h2 id="projects-title">Proyectos de investigación</h2>
      <ul id="projects-list"></ul>
    </section>

    <section id="conferences">
      <h2 id="conferences-title">Presentaciones en Congresos</h2>
      <ul id="conferences-list"></ul>
    </section>

    <section id="skills">
      <h2 id="skills-title">Capacidades</h2>
      <div class="skills-grid" id="skills-grid"></div>
    </section>

    <section id="awards">
      <h2 id="awards-title">Becas y Premios</h2>
      <div id="awards-list"></div>
    </section>
  </main>

  <script>
    // ====== datos base ======
    const content = {
      es: {
        title: "Curriullum Vitae Andres Marcelo Vallone",
        nav: ["Información General","Educación","Experiencia","Publicaciones","Proyectos","Presentaciones","Capacidades","Becas y Premios"],
        generalTitle: "Información General",
        generalText: "Afiliación: Universidad Católica del Norte, Escuela de Ciencias Empresariales - Instituto de Políticas Públicas, Coquimbo, Chile.",
        summary: "Profesor Asociado UCN. Doctor en Economía y Empresa (UAM, 2019). Líneas: economía urbana y regional, redes de innovación, concentración espacial, R para análisis socioeconómicos.",
        education: [
          { degree: "Doctor en Economía y Empresa", institution: "Universidad Autónoma de Madrid, España", years: "2015 – 2019" },
          { degree: "Magíster en Ciencia Regional", institution: "Universidad Católica del Norte, Antofagasta, Chile", years: "2009 – 2011" },
          { degree: "MBA – Master en Administración", institution: "Universidad Católica del Norte, Coquimbo, Chile", years: "2007 – 2009" },
          { degree: "Magíster en Economía y Administración Estratégica de Negocios", institution: "Universidad Católica de Cuyo, Argentina", years: "2006 – 2009" },
          { degree: "Licenciado en Economía", institution: "Universidad Católica de Cuyo, Argentina", years: "1997 – 2004" }
        ],
        undergradCourses: [
          "Macroeconomía II – UCN, Coquimbo (2011–Presente)",
          "Microeconomía I – UCN, Coquimbo (2011–Presente)",
          "Microeconomía II – UCN, Coquimbo (2011–Presente)",
          "Visión del Entorno Económico y Social – UCN",
          "Introducción a la Economía – UCN",
          "Organización Industrial – UCN"
        ],
        postgradCourses: [
          "Apoyo a docencia e investigación, Departamento de Economía Aplicada, UAM (2016–2018)"
        ],
        otherExperience: [
          "Profesor jornada completa, Universidad Católica del Norte, Coquimbo, Chile (2011–presente)",
          "Personal Investigador en Formación, Universidad Autónoma de Madrid, España (2016–2018)"
        ],
        publicationsJournalsTitle: "Revistas indexadas",
        publicationsChaptersTitle: "Capítulos de libro",
        projectsTitle: "Proyectos de investigación",
        conferencesTitle: "Presentaciones en Congresos",
        skillsTitle: "Capacidades",
        awardsTitle: "Becas y Premios",
        projects: [
          { period: "2022", title: "Fortalece PyME Coquimbo – Red de asistencia digital", role: "Co-ejecutor", funding: "CORFO / ASOEX" },
          { period: "2021", title: "Sistematización avances Corredor Bioceánico Central", role: "Investigador", funding: "AGCID" }
        ],
        conferences: [
          { year: "2023", title: "Transformación tecnológica para PYMES del sector agrícola", event: "Seminario Internacional AGRO 5.0", place: "Argentina", extra: "" }
        ],
        skills: {
          languagesTitle: "Idiomas",
          languages: ["Español (nativo)", "Inglés (avalado)", "Portugués (básico)"],
          programmingTitle: "Programación y software",
          programming: ["R","GAMS","Python","LaTeX","ArGIS"],
          otherTitle: "Áreas de interés",
          other: ["Economía urbana y regional","Redes de innovación","Valoración económica de ecosistemas"]
        },
        awards: [
          { year: "2025", text: "Profesor mejor evaluado de la Maestría en Ciencias Empresariales - Escuela de Ciencias Empresariales - Universidad Católica del Norte" },
          { year: "2024", text: "Profesor mejor evaluado de la Maestría en Ciencias Empresariales - Escuela de Ciencias Empresariales - Universidad Católica del Norte" },
          { year: "2023", text: "Profesor mejor evaluado de la Maestría en Ciencias Empresariales - Escuela de Ciencias Empresariales - Universidad Católica del Norte" },
          { year: "2023", text: "Premio a la Innovación docente - “Inclusión de estudiantes ciegos en aula para cursos de economía“, Vicerrectoría Académica - Universidad Católica del Norte" },
          { year: "2021", text: "Investigador emergente del Campus Guayacán, Vicerrectoría En Investigación y Desarrollo Tecnológico - Universidad Católica del Norte" },
          { year: "2009", text: "2009 - 2010 Beca de estudio de postgrado, Departamento de Economía - Universidad Católica del Norte" },
          { year: "2007", text: "2007 - 2009 Beca de estudio de postgrado, Escuela de Ingeniería Comercial - Universidad Católica del Norte" },
          { year: "2006", text: "Beca de estudio de postgrado, Universidad Católica de Cuyo" }
        ]
      },
      en: {
        title: "Curriculum Vitae Andres Marcelo Vallone",
        nav: ["General Information","Education","Experience","Publications","Research Projects","Conference Presentations","Skills","Scholarships & Awards"],
        generalTitle: "General Information",
        generalText: "Affiliation: Universidad Católica del Norte, School of Business Sciences – Institute of Public Policies, Coquimbo, Chile.",
        summary: "Associate Professor at UCN. PhD in Economics and Business (UAM, 2019). Research lines: urban & regional economics, innovation networks, spatial analysis, R for socioeconomic analysis.",
        education: [
          { degree: "PhD in Economics and Business", institution: "Universidad Autónoma de Madrid, Spain", years: "2015 – 2019" },
          { degree: "Master in Regional Science", institution: "Universidad Católica del Norte, Chile", years: "2009 – 2011" }
        ],
        undergradCourses: [
          "Macroeconomics II – UCN (2011–Present)",
          "Microeconomics I – UCN (2011–Present)",
          "Microeconomics II – UCN (2011–Present)"
        ],
        postgradCourses: [
          "Teaching and research support, Dept. of Applied Economics, UAM (2016–2018)"
        ],
        otherExperience: [
          "Full-time professor, Universidad Católica del Norte (2011–present)",
          "Research Fellow, Universidad Autónoma de Madrid (2016–2018)"
        ],
        publicationsJournalsTitle: "Indexed journals",
        publicationsChaptersTitle: "Book chapters",
        projectsTitle: "Research projects",
        conferencesTitle: "Conference Presentations",
        skillsTitle: "Skills",
        awardsTitle: "Scholarships & Awards",
        projects: [
          { period: "2022", title: "Fortalece PyME Coquimbo – Digital assistance network", role: "Co-executor", funding: "CORFO / ASOEX" }
        ],
        conferences: [
          { year: "2023", title: "Technological transformation for agricultural SMEs", event: "International Seminar AGRO 5.0", place: "Argentina", extra: "" }
        ],
        skills: {
          languagesTitle: "Languages",
          languages: ["Spanish (native)", "English", "Portuguese (basic)"],
          programmingTitle: "Programming & software",
          programming: ["R","GAMS","Python","LaTeX","ArGIS"],
          otherTitle: "Research interests",
          other: ["Urban and regional economics","Innovation networks","Ecosystem valuation"]
        },
        awards: [
          { year: "2025", text: "Best evaluated professor, Master in Business Sciences – School of Business Sciences – Universidad Católica del Norte" },
          { year: "2024", text: "Best evaluated professor, Master in Business Sciences – School of Business Sciences – Universidad Católica del Norte" },
          { year: "2023", text: "Best evaluated professor, Master in Business Sciences – School of Business Sciences – Universidad Católica del Norte" },
          { year: "2023", text: "Teaching Innovation Award – “Inclusion of blind students in economics courses”, Academic Vice-Rectory – Universidad Católica del Norte" },
          { year: "2021", text: "Emerging Researcher, Guayacán Campus – Vice-Rectory for Research and Technological Development – Universidad Católica del Norte" },
          { year: "2009", text: "2009–2010 Graduate studies scholarship, Department of Economics – Universidad Católica del Norte" },
          { year: "2007", text: "2007–2009 Graduate studies scholarship, School of Business Engineering – Universidad Católica del Norte" },
          { year: "2006", text: "Graduate studies scholarship, Universidad Católica de Cuyo" }
        ]
      }
    };

    let currentLang = "es";
    let pubsCache = [];
    let presentationsCache = [];
    let projectsCache = [];

    // ====== helpers ======
    // Convierte \textbf{...} -> <strong>...</strong> (inline simple)
    function latexBoldToHTML(str) {
      if (!str) return "";
      return str.replace(/\\textbf\{([^{}]+)\}/g, "<strong>$1</strong>");
    }

    // extrae primer año (cuatro dígitos) para ordenar
    function extractYear(s) {
      const m = String(s||"").match(/\b(19|20)\d{2}\b/);
      return m ? parseInt(m[0]) : -1;
    }

    function formatAuthorsAPA(str) {
      if (!str) return "";
      const parts = str.split(/\s+and\s+/i).map(s => s.trim()).filter(Boolean);
      const formatted = parts.map(a => {
        if (a.includes(",")) {
          const [last, first] = a.split(",").map(x => x.trim());
          const initials = (first || "").split(/\s+/).map(n => n[0]?.toUpperCase() + ".").join(" ");
          return `${last}, ${initials}`.trim();
        } else {
          const tokens = a.split(/\s+/);
          const last = tokens.pop();
          const initials = tokens.map(n => n[0]?.toUpperCase() + ".").join(" ");
          return `${last}, ${initials}`.trim();
        }
      });
      if (formatted.length === 1) return formatted[0];
      if (formatted.length === 2) return formatted.join(" & ");
      return formatted.slice(0,-1).join(", ") + ", & " + formatted[formatted.length-1];
    }

    function parseBibtex(text) {
      const out = [];
      const entries = text.split(/@(?=[a-zA-Z]+)/g).filter(Boolean);
      entries.forEach(chunk => {
        const typeMatch = chunk.match(/^([a-zA-Z]+)\s*{/);
        if (!typeMatch) return;
        const type = typeMatch[1].toLowerCase();
        const keyMatch = chunk.match(/^[a-zA-Z]+\s*{\s*([^,]+),/);
        const key = keyMatch ? keyMatch[1].trim() : "";
        const body = chunk.substring(chunk.indexOf("{") + 1, chunk.lastIndexOf("}"));
        const fields = {};
        const fieldRegex = /(\w+)\s*=\s*(\{(?:[^{}]|{[^{}]*})*\}|"[^"]*")\s*,?/g;
        let m;
        while ((m = fieldRegex.exec(body)) !== null) {
          const name = m[1].toLowerCase();
          let val = m[2].trim();
          if ((val.startsWith("{") && val.endsWith("}")) || (val.startsWith('"') && val.endsWith('"'))) {
            val = val.slice(1, -1);
          }
          fields[name] = val.replace(/\s+/g, " ").trim();
        }
        out.push({ type, key, ...fields });
      });
      return out;
    }

    // ====== render ======
    function renderEducation(lang) {
      const ul = document.getElementById("education-list");
      ul.innerHTML = "";
      content[lang].education.forEach(e => {
        const li = document.createElement("li");
        li.className = "edu-item";
        li.innerHTML = `
          <div class="edu-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="#5e7050"><path d="M32 6 2 20l30 14 30-14L32 6zm0 30.6L10 26v12l22 10 22-10V26L32 36.6z"/></svg>
          </div>
          <div>
            <strong>${e.degree}</strong> – ${e.institution}<br><small>${e.years}</small>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    function renderExperience(lang) {
      document.getElementById("teaching-exp-title").innerText =
        lang === "es" ? "Experiencia docente" : "Teaching experience";
      document.getElementById("undergrad-title").innerText =
        lang === "es" ? "Pregrado" : "Undergraduate";
      document.getElementById("postgrad-title").innerText =
       lang === "es" ? "Postgrado" : "Postgraduate";

      const ug = document.getElementById("undergrad-list");
      const pg = document.getElementById("postgrad-list");
      ug.innerHTML = "";
      pg.innerHTML = "";
      content[lang].undergradCourses.forEach(c => {
        const li = document.createElement("li");
        li.textContent = c;
        ug.appendChild(li);
      });
      content[lang].postgradCourses.forEach(c => {
        const li = document.createElement("li");
        li.textContent = c;
        pg.appendChild(li);
      });

      document.getElementById("other-exp-title").innerText =
        lang === "es" ? "Otras experiencias" : "Other experience";
      const other = document.getElementById("other-exp-list");
      other.innerHTML = "";
      content[lang].otherExperience.forEach(c => {
        const li = document.createElement("li");
        li.textContent = c;
        other.appendChild(li);
      });
    }

    function renderSkills(lang) {
      document.getElementById("skills-title").innerText = content[lang].skillsTitle;
      const box = document.getElementById("skills-grid");
      box.innerHTML = "";
      const s = content[lang].skills;
      const card1 = document.createElement("div");
      card1.className = "skill-card";
      card1.innerHTML = `<h3>${s.languagesTitle}</h3><ul>${s.languages.map(x=>`<li>${x}</li>`).join("")}</ul>`;
      const card2 = document.createElement("div");
      card2.className = "skill-card";
      card2.innerHTML = `<h3>${s.programmingTitle}</h3><ul>${s.programming.map(x=>`<li>${x}</li>`).join("")}</ul>`;
      const card3 = document.createElement("div");
      card3.className = "skill-card";
      card3.innerHTML = `<h3>${s.otherTitle}</h3><ul>${s.other.map(x=>`<li>${x}</li>`).join("")}</ul>`;
      box.appendChild(card1); box.appendChild(card2); box.appendChild(card3);
    }

    function renderAwards(lang) {
      document.getElementById("awards-title").innerText = content[lang].awardsTitle;
      const list = document.getElementById("awards-list");
      list.innerHTML = "";
      const awards = [...content[lang].awards].sort((a,b)=>parseInt(b.year)-parseInt(a.year));
      awards.forEach(a => {
        const div = document.createElement("div");
        div.className = "award-item";
        div.innerHTML = `<strong>${a.year}</strong> – ${a.text}`;
        list.appendChild(div);
      });
    }

    function renderProjects(lang) {
      document.getElementById("projects-title").innerText =
        lang === "es" ? "Proyectos de investigación" : "Research projects";
      const list = document.getElementById("projects-list");
      list.innerHTML = "";
      const source = projectsCache.length ? projectsCache : content[lang].projects;
      const sorted = [...source].sort((a,b)=> extractYear(b.period) - extractYear(a.period));
      sorted.forEach(p => {
        const li = document.createElement("li");
        li.className = "card-list-item";
        li.innerHTML = `
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#bc7d38"><path d="M9 2h6v2h3v18H6V4h3V2zm2 2v1h2V4h-2z"/></svg>
          </div>
          <div>
            <strong>${latexBoldToHTML(p.period) || ""}</strong> – ${latexBoldToHTML(p.title) || ""}<br>
            ${p.role ? latexBoldToHTML(p.role) + ". " : ""}${p.funding ? latexBoldToHTML(p.funding) : ""}${p.institution ? " ("+latexBoldToHTML(p.institution)+")" : ""}
          </div>
        `;
        list.appendChild(li);
      });
    }

    function renderConferences(lang) {
      document.getElementById("conferences-title").innerText =
        lang === "es" ? "Presentaciones en Congresos" : "Conference Presentations";
      const list = document.getElementById("conferences-list");
      list.innerHTML = "";
      const source = presentationsCache.length ? presentationsCache : content[lang].conferences;
      source.forEach(c => {
        const li = document.createElement("li");
        li.className = "card-list-item";
        li.innerHTML = `
          <div class="card-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#5e7050">
              <path d="M3 4h18v10H3zM8 18l-3 3h2l2-2 2 2h2l-3-3z"/>
            </svg>
          </div>
          <div>
            <strong>${latexBoldToHTML(c.year) || ""}</strong> – ${latexBoldToHTML(c.title || c.text || "")}<br>
            ${c.event ? latexBoldToHTML(c.event) : ""}${c.place ? ", " + latexBoldToHTML(c.place) : ""}${c.extra ? " – " + latexBoldToHTML(c.extra) : ""}
          </div>
        `;
        list.appendChild(li);
      });
    }

    function renderPublications() {
      const journalsList = document.getElementById("publications-journals-list");
      const chaptersList = document.getElementById("publications-chapters-list");
      journalsList.innerHTML = "";
      chaptersList.innerHTML = "";
      const sorted = pubsCache.length ? [...pubsCache].sort((a,b)=>(b.year||"").localeCompare(a.year||"")) : [];
      sorted.forEach(pub => {
        const isChapter = pub.type === "incollection" || pub.booktitle;
        const li = document.createElement("li");
        li.className = "card-list-item";
        const icon = document.createElement("div");
        icon.className = "card-icon";
        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#5e7050"><path d="M19 2H8a3 3 0 0 0-3 3v14a3 3 0 0 1 3-3h11v-2H8a5 5 0 0 0-3 1V5a1 1 0 0 1 1-1h12v14h2V2z"/></svg>`;
        const cdiv = document.createElement("div");
        const authors = formatAuthorsAPA(pub.author);
        const year = pub.year ? `(${pub.year}).` : "";
        const title = pub.title ? pub.title.replace(/\.$/, "") + "." : "";
        const abstract = pub.abstract ? `<div class="pub-abstract">${pub.abstract}</div>` : "";
        const doi = pub.doi ? ` https://doi.org/${pub.doi.replace(/^https?:\/\/doi\.org\//,"")}` : (pub.url ? " " + pub.url : "");

        if (isChapter) {
          const booktitle = pub.booktitle ? pub.booktitle.replace(/\.$/, "") : "";
          const publisher = pub.publisher ? pub.publisher : "";
          cdiv.innerHTML = `
            <div class="pub-meta">
              ${authors} ${year} ${title}
              ${booktitle ? `En: <em>${booktitle}</em>.` : ""}
              ${publisher ? ` ${currentLang === "es" ? "Editorial" : "Publisher"}: ${publisher}.` : ""}
              ${doi}
            </div>
            ${abstract}
          `;
          li.appendChild(icon); li.appendChild(cdiv);
          chaptersList.appendChild(li);
        } else {
          const outlet = pub.journal ? `<em>${pub.journal}</em>` : "";
          const volume = pub.volume ? `<em>${pub.volume}</em>` : "";
          const number = pub.number ? `(${pub.number})` : "";
          const pages = pub.pages ? `, ${pub.pages}` : "";
          cdiv.innerHTML = `
            <div class="pub-meta">
              ${authors} ${year} ${title}
              ${outlet}${outlet && (volume || number) ? ", " : ""}${volume}${number}${pages}.${doi}
            </div>
            ${abstract}
          `;
          li.appendChild(icon); li.appendChild(cdiv);
          journalsList.appendChild(li);
        }
      });
    }

    function renderAll(lang) {
      const t = content[lang];
      document.getElementById("title").innerText = t.title;
      document.getElementById("nav-general").innerText = t.nav[0];
      document.getElementById("nav-education").innerText = t.nav[1];
      document.getElementById("nav-experience").innerText = t.nav[2];
      document.getElementById("nav-publications").innerText = t.nav[3];
      document.getElementById("nav-projects").innerText = t.nav[4];
      document.getElementById("nav-conferences").innerText = t.nav[5];
      document.getElementById("nav-skills").innerText = t.nav[6];
      document.getElementById("nav-awards").innerText = t.nav[7];
      document.getElementById("general-title").innerText = t.generalTitle;
      document.getElementById("general-text").innerText = t.generalText;
      document.getElementById("summary-text").innerText = t.summary;
      document.getElementById("education-title").innerText = lang === "es" ? "Educación" : "Education";
      document.getElementById("experience-title").innerText = lang === "es" ? "Experiencia" : "Experience";
      document.getElementById("publications-title").innerText = lang === "es" ? "Publicaciones" : "Publications";
      document.getElementById("skills-title").innerText = t.skillsTitle;
      document.getElementById("awards-title").innerText = t.awardsTitle;
      document.getElementById("projects-title").innerText = t.projectsTitle;
      document.getElementById("conferences-title").innerText = t.conferencesTitle;
      document.getElementById("pub-journals-title").innerText = t.publicationsJournalsTitle;
      document.getElementById("pub-chapters-title").innerText = t.publicationsChaptersTitle;
      renderEducation(lang);
      renderExperience(lang);
      renderSkills(lang);
      renderAwards(lang);
      renderProjects(lang);
      renderConferences(lang);
      renderPublications();
    }

    function toggleLanguage() {
      currentLang = currentLang === "es" ? "en" : "es";
      renderAll(currentLang);
    }

    // ====== carga externa ======
    async function tryLoadBib() {
      try {
        const res = await fetch("./library.bib");
        if (!res.ok) return;
        const txt = await res.text();
        pubsCache = parseBibtex(txt);
      } catch(e) {}
    }

    async function tryLoadPresentations() {
      try {
        const res = await fetch("./presentation.tex");
        if (!res.ok) return;
        let txt = await res.text();
        // quitar \cvsection{...} o \cvsection*{...}
        txt = txt.replace(/\\cvsection\*?\{[^}]*\}/g, "");
        // \cventry{year}{title}{event}{place}{extra}
        const regex = /\\cventry\s*{\s*([^}]*)\s*}\s*{\s*([^}]*)\s*}\s*{\s*([^}]*)\s*}\s*{\s*([^}]*)\s*}\s*{\s*([^}]*)\s*}/g;
        const out = [];
        let m;
        while ((m = regex.exec(txt)) !== null) {
          out.push({
            year: latexBoldToHTML(m[1].trim()),
            title: latexBoldToHTML(m[2].trim()),
            event: latexBoldToHTML(m[3].trim()),
            place: latexBoldToHTML(m[4].trim()),
            extra: latexBoldToHTML(m[5].trim())
          });
        }
        if (out.length) presentationsCache = out;
      } catch(e) {}
    }

    async function tryLoadProjects() {
      try {
        const res = await fetch("./project.tex");
        if (!res.ok) return;
        let txt = await res.text();
        // quitar \cvsection{...} o \cvsection*{...}
        txt = txt.replace(/\\cvsection\*?\{[^}]*\}/g, "");
        // \cvpub{period}{title}{role}{funding}
        // usar [\s\S]*? para permitir saltos de línea en campos
        const regex = /\\cvpub\s*{\s*([\s\S]*?)\s*}\s*{\s*([\s\S]*?)\s*}\s*{\s*([\s\S]*?)\s*}\s*{\s*([\s\S]*?)\s*}/g;
        const out = [];
        let m;
        while ((m = regex.exec(txt)) !== null) {
          out.push({
            period: latexBoldToHTML(m[1].trim()),
            title: latexBoldToHTML(m[2].trim()),
            role: latexBoldToHTML(m[3].trim()),
            funding: latexBoldToHTML(m[4].trim())
          });
        }
        if (out.length) projectsCache = out;
      } catch(e) {}
    }

    document.addEventListener("DOMContentLoaded", function() {
      renderAll("es"); // pinta primero
      tryLoadBib().then(renderPublications);
      tryLoadPresentations().then(()=>renderConferences(currentLang));
      tryLoadProjects().then(()=>renderProjects(currentLang));
    });
  </script>
</body>
</html>
